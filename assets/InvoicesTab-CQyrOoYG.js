import{u as X,r as n,a as u,j as e}from"./index-sFQCxi-d.js";const ee=()=>{var $,L,M,T,U,B,E,O;const{property:a}=X(),d=a==null?void 0:a._id,[Y,b]=n.useState([]),[K,N]=n.useState(!0),[v,f]=n.useState(""),[o,R]=n.useState(""),[w,I]=n.useState(!1),[C,c]=n.useState(""),[j,V]=n.useState(""),[y,q]=n.useState(""),[t,D]=n.useState(null),[g,S]=n.useState(!1),[P,h]=n.useState(""),F=n.useCallback(async()=>{if(d)try{N(!0),f("");const s=await u.get(`/properties/${d}/invoices`);b(s.data)}catch{f("Failed to load invoices.")}finally{N(!1)}},[d]);n.useEffect(()=>{F()},[F]);const z=s=>/^\d{4}-(0[1-9]|1[0-2])$/.test(s),G=async()=>{if(!z(o)){c("Please select a valid month in YYYY-MM format before generating invoices.");return}if(!d){c("Property ID is missing.");return}c(""),I(!0);try{const s=await u.post(`/properties/${d}/invoices/bulk`,{period:o});Array.isArray(s.data)?(b(r=>[...s.data,...r]),c(`Created ${s.data.length} invoices for ${o}.`)):s.data.message&&c(s.data.message)}catch{c("Failed to create invoices.")}finally{I(!1)}},W=async(s,r)=>{try{await u.patch(`/properties/${d}/invoices/${s}/status`,{status:r}),b(i=>i.map(l=>l._id===s?{...l,status:r}:l))}catch{c("Failed to update invoice status.")}},k=Y.filter(s=>{var x,m,p;const r=j?(x=s.tenantId)==null?void 0:x.name.toLowerCase().includes(j.toLowerCase()):!0,i=y?(p=(m=s.unitId||"").toLowerCase)==null?void 0:p.call(m).includes(y.toLowerCase()):!0,l=o?s.period===o:!0;return r&&i&&l}),H=s=>{D(s),h("")},A=()=>{D(null),h("")},J=async()=>{var s;if(t){S(!0),h("");try{const r={method:"email",subject:`Your Invoice for Period ${t.period}`,message:`Dear ${(s=t.tenantId)==null?void 0:s.name}, 
      Please find attached your invoice for the billing period ${t.period}.
      If you have any questions, feel free to contact us.

    Thank you for your prompt payment.

    Best regards,
    ${a==null?void 0:a.propertyName}
  `,invoiceId:t._id};await u.post(`/properties/${d}/invoices/${t._id}/send`,r),h("Invoice sent successfully!")}catch(r){console.error("Failed to send invoice:",r),h("Failed to send invoice.")}finally{S(!1)}}};return e.jsxs("div",{className:"p-4",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Invoices"}),e.jsxs("div",{className:"mb-4 flex flex-wrap gap-4 items-center",children:[e.jsxs("label",{children:["Tenant Name:",e.jsx("input",{type:"text",value:j,onChange:s=>V(s.target.value),placeholder:"Filter by tenant",className:"ml-2 border rounded px-2 py-1"})]}),e.jsxs("label",{children:["Unit:",e.jsx("input",{type:"text",value:y,onChange:s=>q(s.target.value),placeholder:"Filter by unit",className:"ml-2 border rounded px-2 py-1"})]}),e.jsxs("label",{children:["Period:",e.jsx("input",{type:"month",value:o,onChange:s=>R(s.target.value),className:"ml-2 border rounded px-2 py-1",max:new Date().toISOString().slice(0,7)})]})]}),e.jsx("div",{className:"mb-6 flex items-center gap-4",children:e.jsx("button",{onClick:G,disabled:w,className:"bg-cyan-700 text-white px-4 py-2 rounded hover:bg-black disabled:opacity-50",children:w?"Creating...":"Generate Invoices"})}),C&&e.jsx("div",{className:"mb-4 text-sm text-indigo-700 bg-indigo-100 p-2 rounded",children:C}),K?e.jsx("div",{children:"Loading invoices..."}):v?e.jsx("div",{className:"text-red-600",children:v}):k.length===0?e.jsx("div",{children:"No invoices found with current filters."}):e.jsxs("table",{className:"min-w-full border border-gray-300 rounded",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-4 py-2 text-left",children:"Invoice #"}),e.jsx("th",{className:"border px-4 py-2 text-left",children:"Period"}),e.jsx("th",{className:"border px-4 py-2 text-left",children:"Tenant"}),e.jsx("th",{className:"border px-4 py-2 text-left",children:"Unit"}),e.jsx("th",{className:"border px-4 py-2 text-left",children:"Total Due"}),e.jsx("th",{className:"border px-4 py-2 text-left",children:"Status"}),e.jsx("th",{className:"border px-4 py-2 text-left",children:"Issue Date"}),e.jsx("th",{className:"border px-4 py-2 text-center",children:"Sent"}),e.jsx("th",{className:"border px-4 py-2 text-left",children:"Actions"})]})}),e.jsx("tbody",{children:k.map(s=>{var r,i,l;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border px-4 py-2",children:s.invoiceNumber}),e.jsx("td",{className:"border px-4 py-2",children:s.period}),e.jsx("td",{className:"border px-4 py-2",children:((r=s.tenantId)==null?void 0:r.name)||"N/A"}),e.jsx("td",{className:"border px-4 py-2",children:s.unitId||"N/A"}),e.jsx("td",{className:"border px-4 py-2",children:s.totalDue.toFixed(2)}),e.jsx("td",{className:"border px-4 py-2",children:e.jsxs("select",{value:s.status,onChange:x=>W(s._id,x.target.value),className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"Unpaid",children:"Unpaid"}),e.jsx("option",{value:"Partially Paid",children:"Partially Paid"}),e.jsx("option",{value:"Paid",children:"Paid"}),e.jsx("option",{value:"Overdue",children:"Overdue"}),e.jsx("option",{value:"Cancelled",children:"Cancelled"})]})}),e.jsx("td",{className:"border px-4 py-2",children:new Date(s.issueDate).toLocaleDateString()}),e.jsx("td",{className:"border px-4 py-2 text-center",children:(i=s.sent)!=null&&i.email||(l=s.sent)!=null&&l.whatsapp?"âœ…":"âŒ"}),e.jsx("td",{className:"border px-4 py-2",children:e.jsx("button",{onClick:()=>H(s),className:"bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700",children:"View"})})]},s._id)})})]}),t&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg max-w-xl w-full max-h-[90vh] overflow-auto relative",children:[e.jsx("button",{onClick:A,className:"absolute top-2 right-2 text-gray-600 hover:text-gray-900 font-bold","aria-label":"Close preview",children:"âœ•"}),e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"Invoice Preview"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Invoice Date:"})," ",new Date(t.issueDate).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Invoice No:"})," ",t.invoiceNumber]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Property:"})," ",(a==null?void 0:a.propertyName)||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Tenant:"})," ",(($=t.tenantId)==null?void 0:$.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Unit:"})," ",t.unitId||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Period:"})," ",t.period]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",t.status]}),t.lineItems&&e.jsxs("div",{className:"mt-4 border-t pt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-2",children:"Billing Breakdown"}),e.jsxs("table",{className:"min-w-full border text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border px-2 py-1 text-left",children:"Description"}),e.jsx("th",{className:"border px-2 py-1 text-right",children:"Amount (KES)"})]})}),e.jsxs("tbody",{children:[t.lineItems.map((s,r)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1",children:s.label}),e.jsx("td",{className:"border px-2 py-1 text-right",children:s.amount.toFixed(2)})]},r)),e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1 font-semibold",children:"Subtotal"}),e.jsx("td",{className:"border px-2 py-1 text-right font-semibold",children:t.lineItems.reduce((s,r)=>s+r.amount,0).toFixed(2)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1 font-bold",children:"Total Due"}),e.jsx("td",{className:"border px-2 py-1 text-right font-bold",children:((L=t.totalDue)==null?void 0:L.toFixed(2))||"-"})]})]})]})]}),t.lineItems.some(s=>s.label.toLowerCase().includes("water")&&s.detail)&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-2",children:"Water Usage Details"}),e.jsxs("table",{className:"min-w-full border text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border px-2 py-1",children:"Previous"}),e.jsx("th",{className:"border px-2 py-1",children:"Current"}),e.jsx("th",{className:"border px-2 py-1",children:"Units"}),e.jsx("th",{className:"border px-2 py-1",children:"Rate"}),e.jsx("th",{className:"border px-2 py-1",children:"Amount"})]})}),e.jsx("tbody",{children:t.lineItems.filter(s=>s.label.toLowerCase().includes("water")&&s.detail).map((s,r)=>{var _;const i=/(\d+)\D+(\d+)\D+(\d+)\D+(\d+)/,l=(_=s.detail)==null?void 0:_.match(i),[x,m,p,Q]=l?l.slice(1):[null,null,null,null];return e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1 text-center",children:x}),e.jsx("td",{className:"border px-2 py-1 text-center",children:m}),e.jsx("td",{className:"border px-2 py-1 text-center",children:p}),e.jsx("td",{className:"border px-2 py-1 text-center",children:Q}),e.jsx("td",{className:"border px-2 py-1 text-right",children:s.amount.toFixed(2)})]},r)})})]})]})]}),e.jsxs("div",{className:"mb-4 text-sm bg-yellow-200 p-2 rounded",children:["ðŸ” Notes",e.jsx("br",{}),"Please make payment by the due date to avoid penalties.",e.jsxs("div",{className:"mt-2",children:[e.jsx("strong",{children:"Account Name:"})," ",((M=a==null?void 0:a.paymentDetails)==null?void 0:M.accountName)||"N/A"," ",e.jsx("br",{}),e.jsx("strong",{children:"Account Number:"})," ",((T=a==null?void 0:a.paymentDetails)==null?void 0:T.accountNumber)||"N/A"," ",e.jsx("br",{}),e.jsx("strong",{children:"Bank:"})," ",((U=a==null?void 0:a.paymentDetails)==null?void 0:U.bank)||"N/A"," ",e.jsx("br",{}),e.jsx("strong",{children:"Payment Deadline:"})," ",(B=a==null?void 0:a.paymentDetails)!=null&&B.deadline?`By the ${a.paymentDetails.deadline}th  `:"N/A"]}),t.lineItems.some(s=>s.label==="Carried Forward Balance")&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),"Carry-forward balance due from last period:"," ","KES ",(E=t.lineItems.find(s=>s.label==="Carried Forward Balance"))==null?void 0:E.amount.toFixed(2)]}),t.lineItems.some(s=>s.label==="Carried Overpayment")&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),"Overpayment credit from last period: KES ",Math.abs(((O=t.lineItems.find(s=>s.label==="Carried Overpayment"))==null?void 0:O.amount)||0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:A,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",disabled:g,children:"Close"}),e.jsx("button",{onClick:J,disabled:g,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50",children:g?"Sending...":"Send Invoice"})]}),P&&e.jsx("p",{className:"mt-2 text-sm text-indigo-700",children:P})]})]})})]})};export{ee as default};
